<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domain Details - NGShield</title>
    <meta name="description" content="View DNS record history and changes for your domain.">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0EA44B',
                        'primary-dark': '#0C8A3E',
                        accent: '#0B74FF',
                        'accent-dark': '#0960D9',
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: -1rem;
            width: 2px;
            background: #e5e7eb;
        }
        .timeline-item:last-child::before {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="{% url 'app:dashboard' %}" class="flex items-center">
                    <span class="text-2xl font-bold text-primary">NG</span>
                    <span class="text-2xl font-bold text-gray-900">Shield</span>
                </a>
                <a href="{% url 'app:dashboard' %}" class="text-accent hover:text-accent-dark transition font-medium">
                    ‚Üê Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Domain Header -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-4 mb-4">
                        <h1 id="domain-name" class="text-3xl font-bold text-gray-900">{{ domain.name }}</h1>
                        <span id="domain-status" class="px-4 py-2 rounded-full text-sm font-medium">
                            {% if domain.alerts.exists %}
                                <span class="px-4 py-2 rounded-full text-sm font-medium bg-red-500 text-white">ALERT</span>
                            {% else %}
                                <span class="px-4 py-2 rounded-full text-sm font-medium bg-primary text-white">OK</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                        <div>
                            <span class="font-medium">Last Checked:</span>
                            <span id="last-checked" class="ml-2">{{ domain.last_checked|default:"--" }}</span>
                        </div>
                        <div>
                            <span class="font-medium">Monitoring Since:</span>
                            <span id="monitoring-since" class="ml-2">{{ domain.registered_on|date:"Y-m-d" }}</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4 md:mt-0 flex gap-3">
                    <button 
                        id="rescan-btn"
                        class="bg-accent hover:bg-accent-dark text-white px-6 py-3 rounded-lg font-semibold transition shadow"
                    >
                        Rescan Now
                    </button>
                    <button 
                        id="export-btn"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold transition"
                    >
                        Export CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Current DNS Records -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Current DNS Records</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Value</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">TTL</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Changed</th>
                        </tr>
                    </thead>
                    <tbody id="dns-records-table" class="bg-white divide-y divide-gray-200">
                        {% if records %}
                            {% for r in records %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ r.record_type }}</td>
                                    <td class="px-6 py-4 text-sm text-gray-700">{{ r.name }}</td>
                                    <td class="px-6 py-4 text-sm text-gray-700 font-mono">{{ r.value }}</td>
                                    <td class="px-6 py-4 text-sm text-gray-500">{{ r.ttl|default:"-" }}</td>
                                    <td class="px-6 py-4 text-sm text-gray-500">{{ r.last_seen|date:"Y-m-d H:i" }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-gray-500">No DNS records found</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Change History Timeline -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">DNS Change History</h2>
            
            <div id="timeline-container" class="space-y-8">
                {% if changelogs %}
                    {% for item in changelogs %}
                        <div class="relative pl-8 timeline-item">
                            <div class="absolute left-0 top-1 w-4 h-4 rounded-full bg-primary"></div>
                            <div class="bg-gray-50 rounded-lg p-6">
                                <div class="flex items-start justify-between mb-3">
                                    <div>
                                        <h3 class="font-semibold text-gray-900 mb-1">{{ item.get_change_type_display }}</h3>
                                        <p class="text-sm text-gray-500">{{ item.detected_at }}</p>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">{{ item.record_type }}</span>
                                </div>
                                <div class="grid md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <p class="text-gray-600 font-medium mb-1">Previous Value:</p>
                                        <p class="font-mono text-gray-900 bg-white p-2 rounded">{{ item.old_value|default:'N/A' }}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600 font-medium mb-1">New Value:</p>
                                        <p class="font-mono text-gray-900 bg-white p-2 rounded">{{ item.new_value|default:'N/A' }}</p>
                                    </div>
                                </div>
                                {% if item.change_type == 'added' %}
                                    <p class="mt-3 text-sm text-gray-600">A new record was added.</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-8 text-gray-500">No change history available</div>
                {% endif %}
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-white border-l-4 rounded-lg shadow-lg p-4 max-w-sm z-50">
        <div class="flex items-center">
            <div id="toast-icon" class="mr-3"></div>
            <p id="toast-message" class="text-gray-800"></p>
        </div>
    </div>

    <script>
    // Utility: Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            
            toastMessage.textContent = message;
            
            if (type === 'success') {
                toast.className = 'fixed bottom-4 right-4 bg-white border-l-4 border-primary rounded-lg shadow-lg p-4 max-w-sm z-50';
                toastIcon.innerHTML = '<svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
            } else if (type === 'error') {
                toast.className = 'fixed bottom-4 right-4 bg-white border-l-4 border-red-500 rounded-lg shadow-lg p-4 max-w-sm z-50';
                toastIcon.innerHTML = '<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
            }
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 5000);
        }

        // Helper to read a cookie (used for CSRF token)
        function getCookie(name) {
            try {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            } catch (e) {
                return null;
            }
            return null;
        }

    // Domain identifiers
    const DOMAIN_ID = {{ domain.id }};
    // Get domain from URL or fallback to server-rendered DOM value
        const urlParams = new URLSearchParams(window.location.search);
        let domainName = urlParams.get('domain');
        if (!domainName) {
            const el = document.getElementById('domain-name');
            if (el && el.textContent && el.textContent.trim()) {
                domainName = el.textContent.trim();
            }
        }

        // If still not found, go back to dashboard
        if (!domainName) {
            window.location.href = '{% url "app:dashboard" %}';
        }

        // Load domain details by calling the server-side preview/check endpoint.
        // Uses the existing /api/check_domain_status/?domain=... endpoint which returns
        // { domain, status, dns_records, whois, threat_level }
        async function loadDomainDetails() {
            try {
                const response = await fetch(`/api/check_domain_status/?domain=${encodeURIComponent(domainName)}`, {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) throw new Error('Failed to load domain details');
                const data = await response.json();

                // Map the api_check_domain_status response into the render helpers
                const headerData = {
                    domain: data.domain || domainName,
                    status: data.status || (data.threat_level === 'low' ? 'secure' : 'warning'),
                    last_checked: data.last_checked || new Date().toISOString(),
                    monitoring_since: data.monitoring_since || document.getElementById('monitoring-since').textContent
                };

                renderDomainHeader(headerData);
                renderCurrentRecords((data.dns_records || []).map(r => ({
                    type: r.type || r.record_type || r.recordType || 'A',
                    name: r.name || domainName,
                    value: r.value || r.toString?.() || '',
                    ttl: r.ttl || r.ttl_seconds || '-'
                })));

                showToast('Rescan complete', 'success');
            } catch (error) {
                console.error('Error loading domain details:', error);
                showToast('Failed to load domain details', 'error');
            }
        }

        // Render domain header
        function renderDomainHeader(data) {
            document.getElementById('domain-name').textContent = data.domain;
            
            const statusEl = document.getElementById('domain-status');
            const statusClass = data.status === 'secure' ? 'bg-primary text-white' : 
                              data.status === 'warning' ? 'bg-yellow-500 text-white' : 
                              'bg-red-500 text-white';
            statusEl.className = `px-4 py-2 rounded-full text-sm font-medium ${statusClass}`;
            statusEl.textContent = data.status.toUpperCase();
            
            document.getElementById('last-checked').textContent = new Date(data.last_checked).toLocaleString();
            document.getElementById('monitoring-since').textContent = new Date(data.monitoring_since).toLocaleDateString();
        }

        // Render current DNS records
        function renderCurrentRecords(records) {
            const table = document.getElementById('dns-records-table');
            
            if (records.length === 0) {
                table.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No DNS records found</td></tr>';
                return;
            }
            
            table.innerHTML = records.map(record => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${record.type}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${record.name}</td>
                    <td class="px-6 py-4 text-sm text-gray-700 font-mono">${record.value}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${record.ttl}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${record.last_changed ? new Date(record.last_changed).toLocaleDateString() : 'N/A'}</td>
                </tr>
            `).join('');
        }

        // Render history timeline
        function renderHistory(history) {
            const container = document.getElementById('timeline-container');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">No change history available</div>';
                return;
            }
            
            container.innerHTML = history.map((item, index) => `
                <div class="relative pl-8 timeline-item">
                    <div class="absolute left-0 top-1 w-4 h-4 rounded-full bg-primary"></div>
                    <div class="bg-gray-50 rounded-lg p-6">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h3 class="font-semibold text-gray-900 mb-1">${item.change_type || 'DNS Record Change'}</h3>
                                <p class="text-sm text-gray-500">${new Date(item.timestamp).toLocaleString()}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${item.severity === 'high' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">
                                ${item.severity || 'normal'}
                            </span>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-gray-600 font-medium mb-1">Previous Value:</p>
                                <p class="font-mono text-gray-900 bg-white p-2 rounded">${item.previous_value || 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 font-medium mb-1">New Value:</p>
                                <p class="font-mono text-gray-900 bg-white p-2 rounded">${item.new_value || 'N/A'}</p>
                            </div>
                        </div>
                        
                        ${item.description ? `<p class="mt-3 text-sm text-gray-600">${item.description}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }


    // Export to CSV
        document.getElementById('export-btn').addEventListener('click', () => {
            // Get all records from the table
            const table = document.getElementById('dns-records-table');
            const rows = Array.from(table.querySelectorAll('tr'));
            
            // Create CSV content
            let csv = 'Type,Name,Value,TTL,Last Changed\n';
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                if (cells.length > 0) {
                    csv += cells.map(cell => `"${cell.textContent.trim()}"`).join(',') + '\n';
                }
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${domainName}-dns-records-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('CSV exported successfully', 'success');
        });

        // Wire the Rescan button to re-run the check via ID-based API and record a ScanEvent
        (function() {
            const btn = document.getElementById('rescan-btn');
            // store original text once
            if (!btn.getAttribute('data-orig-text')) btn.setAttribute('data-orig-text', btn.textContent || 'Rescan Now');

            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                // prevent double submissions
                if (btn.disabled) return;
                btn.disabled = true;
                const origText = btn.getAttribute('data-orig-text') || 'Rescan Now';
                btn.textContent = 'Scanning...';
                try {
                    const resp = await fetch(`/api/domains/${DOMAIN_ID}/rescan/`, {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken') || ''
                        }
                    });

                    if (!resp.ok) {
                        // try to extract error message
                        let text = 'Rescan failed';
                        try { const j = await resp.json(); if (j && j.error) text = j.error; } catch (e) { /* ignore */ }
                        throw new Error(text);
                    }

                    const data = await resp.json();
                    // Update UI with returned data
                    renderDomainHeader({ domain: data.domain, status: data.status, last_checked: new Date().toISOString(), monitoring_since: document.getElementById('monitoring-since').textContent });
                    renderCurrentRecords((data.dns_records || []).map(r => ({ type: r.type, name: r.name, value: r.value, ttl: r.ttl })));
                    showToast('Rescan complete', 'success');

                    // Also refresh dashboard chart (scan recorded) via parent if available
                    if (window.parent && typeof window.parent.loadChangeHistory === 'function') {
                        try { window.parent.loadChangeHistory(); } catch (e) { /* ignore cross-origin */ }
                    }
                } catch (err) {
                    console.error(err);
                    showToast(err.message || 'Rescan failed', 'error');
                } finally {
                    btn.disabled = false;
                    btn.textContent = origText;
                }
            });
        })();

        // Optionally perform an initial background load (non-blocking)
        window.addEventListener('DOMContentLoaded', () => {
            // Do not block rendering; attempt a background refresh but ignore failures
            loadDomainDetails().catch(() => {});
        });
    </script>
</body>
</html>